<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../resources/report.css" type="text/css"/><link rel="shortcut icon" href="../resources/report.gif" type="image/gif"/><title>TableActivity.java</title><link rel="stylesheet" href="../resources/prettify.css" type="text/css"/><script type="text/javascript" src="../resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">deltagraphs.norrisviewer.view.graphsView</a> &gt; <span class="el_source">TableActivity.java</span></div><h1>TableActivity.java</h1><pre class="source lang-java linenums">package deltagraphs.norrisviewer.view.graphsView;

import android.content.Context;
import android.os.Bundle;
import android.support.v7.app.ActionBarActivity;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.WindowManager;
import android.widget.TextView;

import com.inqbarna.tablefixheaders.TableFixHeaders;
import com.inqbarna.tablefixheaders.adapters.BaseTableAdapter;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;

import deltagraphs.norrisviewer.R;
import deltagraphs.norrisviewer.model.flowModel.FlowModel;
import deltagraphs.norrisviewer.model.flowModel.TableFlow;
import deltagraphs.norrisviewer.presenter.graphsPresenter.TablePresenter;
import deltagraphs.norrisviewer.presenter.graphsPresenter.TablePresenterImpl;

/*
 * Name : TableActivity.java
 * Module : norrisviewer::view::graphsView
 * Location : norrisviewer\view\graphsView
 *
 * History :

 * Version Date Programmer Description
 * ===============================================================
 *
 * 0.5.1 2015-06-15 Davide Trivellato Fixes to table settings
 *
 * 0.5.0 2015-06-15 Davide Trivellato Several changes to setData(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns)
 *
 * 0.4.0 2015-06-14 Davide Trivellato Several changes to sort(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns)
 *
 * 0.3.0 2015-06-13 Davide Trivellato Add sort(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns)
 *
 * 0.2.0 2015-06-12 Davide Trivellato Update setData(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns)
 *
 * 0.1.1 2015-06-11 Davide Trivellato Update setData(ArrayList&lt;FlowModel&gt; flowList) to setData(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns)
 *
 * 0.1.0 2015-06-11 Davide Trivellato Coding of methods and attributes
 *
 * 0.0.1 2015-06-09 Davide Trivellato Creation of the file
 *
 * ===============================================================
 *
 */


<span class="fc" id="L58">public class TableActivity extends ActionBarActivity implements TableView {</span>

    private TableFixHeaders tableFixHeaders;
    private BaseTableAdapter baseTableAdapter;
    private String sourceURL;
    private String sourceTitle;
<span class="fc" id="L64">    private String order = null;</span>
<span class="fc" id="L65">    private int sortingColumn = -1;</span>
    private TablePresenter tablePresenter;
    private String headers[];
<span class="fc" id="L68">    private int rows = 0;</span>

    /*
    This method is called on the creation of the activity
    and its job is to get information from
    previous activity to get title and URL.
     */
    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L77">        super.onCreate(savedInstanceState);</span>

<span class="nc" id="L79">        getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,</span>
               WindowManager.LayoutParams.FLAG_FULLSCREEN);

<span class="nc" id="L82">        Bundle extras = getIntent().getExtras();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (extras != null) {</span>
<span class="nc" id="L84">            sourceURL = extras.getString(&quot;EXTRA_SOURCE_URL&quot;);</span>
<span class="nc" id="L85">            sourceTitle = extras.getString(&quot;EXTRA_SOURCE_TITLE&quot;);</span>
        }
<span class="nc" id="L87">        baseTableAdapter = new RecordListAdapter(this);</span>
<span class="nc" id="L88">        setContentView(R.layout.table);</span>
<span class="nc" id="L89">        tableFixHeaders = (TableFixHeaders) findViewById(R.id.table);</span>
<span class="nc" id="L90">        tablePresenter = new TablePresenterImpl(this, sourceURL);</span>
<span class="nc" id="L91">    }</span>

    /*
    This method is called when the activity is show back form a pause state.
     */
    @Override
    public void onResume() {
<span class="nc" id="L98">        tablePresenter = new TablePresenterImpl(this, sourceURL);</span>
<span class="nc" id="L99">        super.onResume();</span>
<span class="nc" id="L100">    }</span>

    /*
    The following method is called when this activity
    is stopped and put on the background and
    it's in charge of destroying the socket connection
     */
    @Override
    public void onStop() {
<span class="nc" id="L109">        tablePresenter.destroyConnection();</span>
<span class="nc" id="L110">        super.onStop();</span>
<span class="nc" id="L111">    }</span>

    /*
    The following method is called when this activity
    is hidden to the user and put on the background and
    it's in charge of destroying the socket connection
     */
    @Override
    public void onPause() {
<span class="nc" id="L120">        tablePresenter.destroyConnection();</span>
<span class="nc" id="L121">        super.onPause();</span>
<span class="nc" id="L122">    }</span>

    /*
   The following method is called when the activity
   is restarted
    */
    @Override
    public void onRestart() {
        //mapChartPresenter.startConnection();
<span class="nc" id="L131">        super.onRestart();</span>
<span class="nc" id="L132">    }</span>

    /*
    This method is called when the activity is destroyed and provides
    to destroy the connection with the socket
    */
    @Override
    public void onDestroy() {
<span class="nc" id="L140">        tablePresenter.destroyConnection();</span>
<span class="nc" id="L141">        super.onDestroy();</span>
<span class="nc" id="L142">    }</span>

    /* This method generate a custom menu for the
    action bar on the top of the activity  */
    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
<span class="nc" id="L149">        getMenuInflater().inflate(R.menu.menu_table, menu);</span>
<span class="nc" id="L150">        return true;</span>
    }

    /* This method menage the actions user can perform
    on the menu */
    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
<span class="nc" id="L160">        int id = item.getItemId();</span>

        //noinspection SimplifiableIfStatement
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (id == R.id.action_settings) {</span>
<span class="nc" id="L164">            return true;</span>
        }

<span class="nc" id="L167">        return super.onOptionsItemSelected(item);</span>
    }

    // set the table to be sorted by a defined column
    @Override
    public void setSortByCol(String sortingColumn) {
<span class="nc" id="L173">        int col = 0;</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">        for (col = 0; (!(headers[col].equals(sortingColumn)) &amp;&amp; (col &lt; headers.length)); col++) ;</span>
        //while(!(headers[col].equals(sortingColumn)))
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (col &gt;= headers.length)</span>
<span class="nc" id="L177">            col = -1;</span>
<span class="nc" id="L178">        this.sortingColumn = col;</span>
<span class="nc" id="L179">    }</span>

    // set if the table must be sorted in ascendent or descendent order
    @Override
    public void setSortOrder(String sortOrder) {
<span class="nc" id="L184">        order = sortOrder;</span>
<span class="nc" id="L185">    }</span>

    // set the headers of the table
    @Override
    public void setHeaders(String[] headers) {
<span class="nc" id="L190">        this.headers = headers;</span>
<span class="nc" id="L191">    }</span>


    // the following method is used to sort the table. It uses java library's methods and at the end of it
    // the list of records is defined on the ordered table.
    private void sort(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns) {
<span class="nc" id="L197">        ArrayList&lt;ArrayList&lt;String&gt;&gt; table = new ArrayList&lt;ArrayList&lt;String&gt;&gt;();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (int i = 0; i &lt; flowList.size(); i++) {</span>
<span class="nc" id="L199">            TableFlow tableFlow = (TableFlow) flowList.get(i);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (int j = 0; j &lt; tableFlow.getRecordSize(); j++) {</span>
<span class="nc" id="L201">                tableFlow.getRecordId(j);</span>
<span class="nc" id="L202">                ArrayList&lt;String&gt; row = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                for (int indexCol = 0; indexCol &lt; numOfColumns; indexCol++) {</span>
<span class="nc" id="L204">                    row.add(tableFlow.getCellData(j, indexCol));</span>
                }
<span class="nc" id="L206">                table.add(row);</span>
            }
        }

<span class="nc" id="L210">        Collections.sort(table, new Comparator&lt;ArrayList&lt;String&gt;&gt;() {</span>
            @Override
            public int compare(ArrayList&lt;String&gt; a, ArrayList&lt;String&gt; b) {
<span class="nc" id="L213">                return a.get(sortingColumn).compareTo(b.get(sortingColumn));</span>
            }
        });

<span class="nc bnc" id="L217" title="All 2 branches missed.">        for (int j = 0; j &lt; table.size(); j++) {</span>
<span class="nc" id="L218">            String[] values = new String[numOfColumns];</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">            for (int i = 0; i &lt; numOfColumns; i++) {</span>
<span class="nc" id="L220">                values[i] = table.get(j).get(i);</span>
            }
<span class="nc" id="L222">            ((RecordListAdapter) baseTableAdapter).families[0].list.add(new Record(values));</span>

        }
<span class="nc" id="L225">        rows = table.size();</span>
<span class="nc" id="L226">    }</span>

    //set the data in the table. It is extracted from the table model
    @Override
    public void setData(ArrayList&lt;FlowModel&gt; flowList, int numOfColumns) {
<span class="nc" id="L231">        rows = 0;</span>
<span class="nc" id="L232">        baseTableAdapter = new RecordListAdapter(this);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (sortingColumn == -1) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">            for (int i = 0; i &lt; flowList.size(); i++) {</span>
<span class="nc" id="L235">                TableFlow tableFlow = (TableFlow) flowList.get(i);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                for (int j = 0; j &lt; tableFlow.getRecordSize(); j++) {</span>
<span class="nc" id="L237">                    String[] values = new String[numOfColumns];</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                    for (int indexCol = 0; indexCol &lt; numOfColumns; indexCol++) {</span>
<span class="nc" id="L239">                        values[indexCol] = tableFlow.getCellData(j, indexCol);</span>
                    }
<span class="nc" id="L241">                    ((RecordListAdapter) baseTableAdapter).families[0].list.add(new Record(values));</span>
<span class="nc" id="L242">                    rows++;</span>
                }
            }
        } else {
<span class="nc" id="L246">            sort(flowList, numOfColumns);</span>
        }
<span class="nc" id="L248">        tableFixHeaders.setAdapter(baseTableAdapter);</span>
<span class="nc" id="L249">        baseTableAdapter.notifyDataSetChanged();</span>
<span class="nc" id="L250">        tableFixHeaders.animate();</span>
<span class="nc" id="L251">    }</span>

    //classes added from the table library

    private class RecordList {
        private final String name;
        private final List&lt;Record&gt; list;

        RecordList(String name) {
            this.name = name;
            list = new ArrayList&lt;Record&gt;();
        }

        public int size() {
            return list.size();
        }

        public Record get(int i) {
            return list.get(i);
        }
    }

    private class Record {
        private final String[] data;

        private Record(String[] values) {
            data = values;
        }

    }


<span class="fc" id="L283">    public class RecordListAdapter extends BaseTableAdapter {</span>

        RecordList families[];

        private final int[] widths = {
                80
        };
        private final float density;

        public RecordListAdapter(Context context) {
            families = new RecordList[]{
                    new RecordList(&quot;&quot;)
            };

            density = context.getResources().getDisplayMetrics().density;
        }

        @Override
        public int getRowCount() {
            return rows;
        }

        @Override
        public int getColumnCount() {
            return headers.length - 1;
        }

        @Override
        public View getView(int row, int column, View convertView, ViewGroup parent) {
            final View view;
            switch (getItemViewType(row, column)) {
                case 0:
                    view = getFirstHeader(row, column, convertView, parent);
                    break;
                case 1:
                    view = getHeader(row, column, convertView, parent);
                    break;
                case 2:
                    view = getFirstBody(row, column, convertView, parent);
                    break;
                case 3:
                    view = getBody(row, column, convertView, parent);
                    break;
                case 4:
                    view = getFamilyView(row, column, convertView, parent);
                    break;
                default:
                    throw new RuntimeException(&quot;wtf?&quot;);
            }
            return view;
        }

        private View getFirstHeader(int row, int column, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = getLayoutInflater().inflate(R.layout.item_table_header_first, parent, false);
            }
            ((TextView) convertView.findViewById(android.R.id.text1)).setText(headers[0]);
            return convertView;
        }

        private View getHeader(int row, int column, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = getLayoutInflater().inflate(R.layout.item_table_header, parent, false);
            }
            ((TextView) convertView.findViewById(android.R.id.text1)).setText(headers[column + 1]);
            return convertView;
        }

        private View getFirstBody(int row, int column, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = getLayoutInflater().inflate(R.layout.item_table_first, parent, false);
            }
            convertView.setBackgroundResource(row % 2 == 0 ? R.drawable.bg_table_color1 : R.drawable.bg_table_color2);
            ((TextView) convertView.findViewById(android.R.id.text1)).setText(getDevice(row).data[column + 1]);
            return convertView;
        }

        private View getBody(int row, int column, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = getLayoutInflater().inflate(R.layout.item_table, parent, false);
            }
            convertView.setBackgroundResource(row % 2 == 0 ? R.drawable.bg_table_color1 : R.drawable.bg_table_color2);
            ((TextView) convertView.findViewById(android.R.id.text1)).setText(getDevice(row).data[column + 1]);
            return convertView;
        }

        private View getFamilyView(int row, int column, View convertView, ViewGroup parent) {
            if (convertView == null) {
                convertView = getLayoutInflater().inflate(R.layout.item_table_family, parent, false);
            }
            final String string;
            if (column == -1) {
                string = getFamily(0).name;
            } else {
                string = &quot;&quot;;
            }
            ((TextView) convertView.findViewById(android.R.id.text1)).setText(string);
            return convertView;
        }

        @Override
        public int getWidth(int column) {
            return Math.round(80 * density);
        }

        @Override
        public int getHeight(int row) {
            /*final int height;
            if (row == -1) {
                height = 35;
            } else if (isFamily(row)) {
                height = 25;
            } else {
                height = 45;
            }*/
            return Math.round(35 * density);
        }

        @Override
        public int getItemViewType(int row, int column) {
            final int itemViewType;
            if (row == -1 &amp;&amp; column == -1) {
                itemViewType = 0;
            } else if (row == -1) {
                itemViewType = 1;
            } else if (isFamily(row)) {
                itemViewType = 4;
            } else if (column == -1) {
                itemViewType = 2;
            } else {
                itemViewType = 3;
            }
            return itemViewType;
        }

        private boolean isFamily(int row) {
            int family = 0;
            while (row &gt; 0) {
                row -= families[family].size() + 1;
                family++;
            }
            return row == 0;
        }

        private RecordList getFamily(int row) {
            int family = 0;
            while (row &gt;= 0) {
                row -= families[family].size() + 1;
                family++;
            }
            return families[family - 1];
        }

        private Record getDevice(int row) {
            int family = 0;
            while (row &gt;= 0) {
                row -= families[family].size() + 1;
                family++;
            }
            family--;
            return families[family].get(row + families[family].size());
        }

        @Override
        public int getViewTypeCount() {
            return 5;
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>